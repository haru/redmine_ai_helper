<div class="ai-helper-project-health ai-helper-health-report-detail box"<%= ' dir="rtl"'.html_safe if l(:direction) == 'rtl' %>>
  <div class="contextual">
    <%= link_to l(:button_back),
                ai_helper_dashboard_path(@project, tab: 'health_report'),
                class: 'icon icon-cancel' %>
  </div>

  <h3><%= sprite_icon('ai-helper-robot', l(:label_ai_helper_health_report_detail), plugin: :redmine_ai_helper) %></h3>

  <div class="ai-helper-health-report-meta">
    <p>
      <strong><%= l(:field_created_on) %>:</strong>
      <%= format_time(@health_report.created_at) %>
    </p>
    <p>
      <strong><%= l(:field_author) %>:</strong>
      <%= link_to_user @health_report.user %>
    </p>
  </div>

  <div class="ai-helper-project-health-content">
    <div id="ai-helper-project-health-result" class="ai-helper-final-content">
      <%= raw textilizable(@health_report.health_report.to_s, object: @project) %>
    </div>
    <input type="hidden" id="ai-helper-health-report-content" value="<%= html_escape(@health_report.health_report.to_s) %>" />
  </div>

  <p class="other-formats">
    <%= l(:label_export_to) %>
    <span><a href="#" id="export-markdown-link" class="text">Markdown</a></span>
    <span><%= link_to 'PDF',
                      ai_helper_health_report_show_path(@project,
                                                       report_id: @health_report.id,
                                                       format: :pdf),
                      class: 'pdf' %></span>
  </p>

  <%= form_tag ai_helper_project_health_markdown_path(@project), method: :post, id: 'markdown-export-form', style: 'display:none;' do %>
    <%= hidden_field_tag 'health_report_content', @health_report.health_report.to_s %>
  <% end %>
</div>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'ai_helper_rtl', plugin: 'redmine_ai_helper' if l(:direction) == 'rtl' %>
  <%= javascript_tag do %>
    document.addEventListener('DOMContentLoaded', function() {
      var hiddenField = document.getElementById('ai-helper-health-report-content');
      var resultDiv = document.getElementById('ai-helper-project-health-result');
      if (!hiddenField || !resultDiv) { return; }
      if (typeof AiHelperMarkdownParser === 'undefined') { return; }
      var content = hiddenField.value;
      if (!content) { return; }
      var parser = new AiHelperMarkdownParser();
      var formattedContent = parser.parse(content);
      resultDiv.innerHTML = '<div class="ai-helper-final-content">' + formattedContent + '</div>';

      // Handle Markdown export
      var exportLink = document.getElementById('export-markdown-link');
      var exportForm = document.getElementById('markdown-export-form');
      if (exportLink && exportForm) {
        exportLink.addEventListener('click', function(e) {
          e.preventDefault();
          exportForm.submit();
        });
      }
    });
  <% end %>
<% end %>
