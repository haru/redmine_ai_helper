<div class="ai-helper-health-report-history">
  <h4><%= l(:label_ai_helper_health_report_history) %></h4>

  <% if @health_reports.any? %>
    <%= form_tag ai_helper_health_report_compare_path(@project), method: :get, id: 'health-report-compare-form' do %>
      <div class="ai-helper-health-report-actions">
        <div class="ai-helper-health-report-actions-left">
          <%= submit_tag l('ai_helper.health_report_comparison.compare_button'),
                         class: 'btn-compare',
                         disabled: true,
                         id: 'compare-reports-button' %>
        </div>
        <div class="ai-helper-health-report-actions-right">
          <%= link_to sprite_icon('add', t('ai_helper.project_health.generate_report')),
                      ai_helper_generate_project_health_path(@project),
                      class: 'icon icon-add ai-helper-generate-report-link',
                      id: 'ai-helper-generate-project-health-link' %>
        </div>
      </div>

      <table class="list ai-helper-report-list">
        <thead>
          <tr>
            <th>#</th>
            <th colspan="2"><%= l('ai_helper.health_report_comparison.comparison_column') %></th>
            <th><%= l(:field_created_on) %></th>
            <th><%= l(:field_author) %></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% report_count = @health_reports.size %>
          <% @health_reports.each_with_index do |report, index| %>
            <% is_first = index.zero? %>
            <% is_last = index == report_count - 1 %>
            <% show_new_radio = report_count > 1 && !is_last %>
            <% show_old_radio = report_count > 1 && !is_first %>
            <% default_new_selected = params[:new_id].blank? && index.zero? %>
            <% default_old_selected = params[:old_id].blank? && report_count > 1 && index == 1 %>
            <% new_selected = if params[:new_id].present?
                                params[:new_id].to_s == report.id.to_s
                              else
                                default_new_selected
                              end %>
            <% old_selected = if params[:old_id].present?
                                params[:old_id].to_s == report.id.to_s
                              else
                                default_old_selected
                              end %>
            <tr class="ai-helper-report-row <%= cycle('odd', 'even') %> <%= 'selected' if @selected_report&.id == report.id %>"
                data-report-id="<%= report.id %>"
                data-report-url="<%= ai_helper_dashboard_path(@project, tab: 'health_report', report_id: report.id, format: :html) %>"
                data-report-content="<%= html_escape(report.health_report.to_s) %>"
                data-report-created-at="<%= report.created_at.iso8601 %>"
                data-report-user-name="<%= html_escape(report.user.name) %>">

              <td class="id ai-helper-clickable-cell">
                <%= report.id %>
              </td>
              <!-- Radio button for selecting the newer report -->
              <td class="radio">
                <% if show_new_radio %>
                  <%= radio_button_tag 'new_id', report.id,
                                       new_selected,
                                       class: 'comparison-radio new-radio',
                                       onclick: 'updateComparisonButton()' %>
                <% else %>
                  <span class="radio-placeholder" aria-hidden="true"></span>
                <% end %>
              </td>
              <!-- Radio button for selecting the older report -->
              <td class="radio">
                <% if show_old_radio %>
                  <%= radio_button_tag 'old_id', report.id,
                                       old_selected,
                                       class: 'comparison-radio old-radio',
                                       onclick: 'updateComparisonButton()' %>
                <% else %>
                  <span class="radio-placeholder" aria-hidden="true"></span>
                <% end %>
              </td>

              <td class="created_on ai-helper-clickable-cell">
                <%= format_time(report.created_at) %>
              </td>
              <td class="author">
                <%= link_to_user report.user %>
              </td>
              <td class="buttons">
                <% if report.deletable? %>
                  <%= link_to sprite_icon('del', l(:button_delete)),
                              ai_helper_health_report_destroy_path(@project, report_id: report.id),
                              method: :delete,
                              data: { confirm: l(:text_are_you_sure) },
                              class: 'icon icon-del',
                              onclick: 'event.stopPropagation();' %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>

      <span class="pagination"><%= pagination_links_full @health_report_pages, @health_report_count %></span>
    <% end %>
  <% else %>
    <div class="ai-helper-health-report-actions">
      <div class="ai-helper-health-report-actions-left"></div>
      <div class="ai-helper-health-report-actions-right">
        <%= link_to sprite_icon('add', t('ai_helper.project_health.generate_report')),
                    ai_helper_generate_project_health_path(@project),
                    class: 'icon icon-add ai-helper-generate-report-link',
                    id: 'ai-helper-generate-project-health-link' %>
      </div>
    </div>
    <p class="nodata"><%= l(:label_no_data) %></p>
  <% end %>
</div>
