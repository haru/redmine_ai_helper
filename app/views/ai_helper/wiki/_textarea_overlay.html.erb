<%
  project = @wiki&.project || @project
%>


<% if params[:controller] == 'wiki' && (params[:action] == 'edit' || params[:action] == 'show') && project&.module_enabled?(:ai_helper) && User.current.allowed_to?(:view_ai_helper, project) && User.current.allowed_to?(:edit_wiki_pages, project) %>

<div id="ai-helper-wiki-checkbox-container" class="ai-helper-autocompletion-controls" style="display: none;">
  <p style="display: flex; justify-content: space-between; align-items: center;">
    <span>
      <input type="checkbox" id="ai-helper-autocompletion-wiki-toggle" />
      <label for="ai-helper-autocompletion-wiki-toggle">
        <%= sprite_icon("ai-helper-robot", plugin: :redmine_ai_helper) %>
        <%= t('ai_helper.autocompletion.common_toggle_label') %>
      </label>
    </span>

    <!-- Typo check button -->
    <%= link_to "javascript:void(0)", id: "ai-helper-typo-check-wiki-btn", class: "icon icon-edit" do %>
      <%= sprite_icon("ai-helper-robot", plugin: :redmine_ai_helper) %>
      <%= t('ai_helper.typo_check.check_button') %>
    <% end %>
  </p>
</div>

<!-- Typo Control Panel for Wiki -->
<div id="ai-helper-typo-control-panel-wiki" class="ai-helper-typo-control-panel" style="display: none;">
  <button type="button" class="ai-helper-typo-apply-all-btn">
    <%= t('ai_helper.typo_check.accept_all') %>
  </button>
  <button type="button" class="ai-helper-typo-close-btn">
    <%= t('ai_helper.typo_check.close') %>
  </button>
</div>

<script>
function initializeWikiCompletion() {
  if (window.aiHelperWikiCompletionInitialized) {
    return;
  }

  const wikiTextarea = document.getElementById('content_text');

  <%
    config_path = Rails.root.join('plugins', 'redmine_ai_helper', 'config', 'ai_helper', 'config.yml')
    autocompletion_config = {}
    if File.exist?(config_path)
      begin
        config_data = YAML.load_file(config_path)
        autocompletion_config = config_data['autocompletion'] || {}
      rescue => e
        autocompletion_config = {}
      end
    end
  %>
  const config = {
    debounce_delay: <%= autocompletion_config['debounce_delay'] || 300 %>,
    min_length: <%= autocompletion_config['wiki_min_length'] || 5 %>,
    suggestion_color: '<%= autocompletion_config['suggestion_color'] || '#888888' %>'
  };

  if (wikiTextarea && typeof AiHelperAutoCompletion !== 'undefined') {
    // Detect wiki page name from URL for proper endpoint
    const pageMatch = window.location.pathname.match(/\/wiki\/([^\/]+)/);
    let endpoint = '<%= ai_helper_suggest_wiki_completion_path(project.identifier) %>';
    if (pageMatch) {
      const pageName = pageMatch[1].replace(/\/edit.*$/, ''); // remove /edit suffix
      endpoint = `/projects/<%= project.identifier %>/ai_helper/wiki/${pageName}/suggest_completion`;
    }

    const wikiAutoCompletion = new AiHelperAutoCompletion(wikiTextarea, {
      contextType: 'wiki',
      endpoint: endpoint,
      debounceDelay: config.debounce_delay,
      minLength: config.min_length,
      suggestionColor: config.suggestion_color,
      // Section edit detection from ERB
      customRequestData: function(text, cursorPosition) {
        return {
          text: text,
          cursor_position: cursorPosition,
          context_type: 'wiki',
          is_section_edit: <%= @section.present? ? 'true' : 'false' %>
        };
      },
      labels: {
        commonToggleLabel: '<%= t('ai_helper.autocompletion.common_toggle_label') %>',
        loading: '<%= t('ai_helper.autocompletion.loading') %>',
        noSuggestions: '<%= t('ai_helper.autocompletion.no_suggestions') %>',
        acceptSuggestion: '<%= t('ai_helper.autocompletion.accept_suggestion') %>',
        dismiss: '<%= t('ai_helper.autocompletion.dismiss') %>',
        enabledTooltip: '<%= t('ai_helper.autocompletion.enabled_tooltip') %>',
        disabledTooltip: '<%= t('ai_helper.autocompletion.disabled_tooltip') %>'
      }
    });

    wikiAutoCompletion.init();

    const wikiContainer = document.getElementById('ai-helper-wiki-checkbox-container');
    if (wikiContainer && wikiTextarea) {
      const parent = wikiTextarea.parentNode;
      const nextSibling = wikiTextarea.nextSibling;
      if (nextSibling) {
        parent.insertBefore(wikiContainer, nextSibling);
      } else {
        parent.appendChild(wikiContainer);
      }
      wikiContainer.style.display = 'block';
    }

    if (!window.aiHelperInstances) {
      window.aiHelperInstances = {};
    }
    window.aiHelperInstances.wikiAutoCompletion = wikiAutoCompletion;
  }

  window.aiHelperWikiCompletionInitialized = true;
}

// Initialize wiki typo checking with direct button binding
function initializeWikiTypoChecker() {
  const wikiTextarea = document.getElementById('content_text');
  const wikiButton = document.getElementById('ai-helper-typo-check-wiki-btn');

  if (wikiTextarea && wikiButton && typeof AiHelperTypoChecker !== 'undefined') {
    const wikiTypoChecker = new AiHelperTypoChecker(wikiTextarea, {
      endpoint: '<%= ai_helper_check_typos_path(project) %>',
      labels: {
        suggestionsTitle: '<%= t('ai_helper.typo_check.suggestions_title') %>',
        noSuggestions: '<%= t('ai_helper.typo_check.no_suggestions') %>',
        checkButton: '<%= t('ai_helper.typo_check.check_button') %>',
        checking: '<%= t('ai_helper.typo_check.checking') %>',
        acceptSuggestion: '<%= t('ai_helper.typo_check.accept_suggestion') %>',
        dismissSuggestion: '<%= t('ai_helper.typo_check.dismiss_suggestion') %>',
        acceptAll: '<%= t('ai_helper.typo_check.accept_all') %>',
        dismissAll: '<%= t('ai_helper.typo_check.dismiss_all') %>',
        errorOccurred: '<%= t('ai_helper.typo_check.error_occurred') %>',
        correctionTooltip: '<%= t('ai_helper.typo_check.correction_tooltip') %>',
        applyFailed: '<%= t('ai_helper.typo_check.apply_failed') %>'
      }
    });
    wikiTypoChecker.init();

    // Bind existing button directly
    wikiButton.addEventListener('click', () => {
      wikiTypoChecker.checkTypos();
    });
  }
}

setTimeout(function() {
  initializeWikiCompletion();
  initializeWikiTypoChecker();
}, 500);

</script>
<% else %>
<!-- AI Helper wiki auto-completion not available -->
<% end %>

<!-- Hidden templates for typo check buttons -->
<div id="ai-helper-typo-button-templates" style="display: none;">
  <button type="button" class="ai-helper-typo-accept-btn-template"><%= sprite_icon("ai-helper-check", plugin: :redmine_ai_helper) %></button>
  <button type="button" class="ai-helper-typo-reject-btn-template"><%= sprite_icon("ai-helper-x", plugin: :redmine_ai_helper) %></button>
</div>
