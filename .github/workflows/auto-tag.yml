name: Auto Tag from init.rb on Release Merge

on:
  pull_request:
    branches:
      - main
    types: [closed]

jobs:
  tag-and-backmerge:
    # Run only when "merged" and "source branch starts with release/"
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version from init.rb
        id: get_version
        run: |
          VERSION=$(grep -oP '^\s*version\s+["\x27]\K[0-9.]+' init.rb)
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from init.rb"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create and Push Tag
        run: |
          git checkout main
          if git rev-parse --verify "refs/tags/${{ env.VERSION }}" >/dev/null 2>&1; then
            echo "Tag ${{ env.VERSION }} already exists, skipping"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "${{ env.VERSION }}"
            git push origin "${{ env.VERSION }}" || echo "Tag push failed, possibly already exists"
          fi

      - name: Create backmerge PR to develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch develop to ensure it is available for comparison
          git fetch origin develop

          # Check if main is already merged into develop
          if git merge-base --is-ancestor origin/main origin/develop; then
            echo "main is already merged into develop, skipping PR creation"
            exit 0
          fi

          # Check if a backmerge PR already exists
          EXISTING_PR=$(gh pr list --base develop --head main --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            echo "Backmerge PR #$EXISTING_PR already exists, skipping"
            exit 0
          fi

          # Create a new backmerge PR
          BODY="Automated backmerge of main to develop after release ${{ env.VERSION }}.

          This PR was created automatically by GitHub Actions."

          PR_URL=$(gh pr create \
            --base develop \
            --head main \
            --title "Backmerge main to develop (${{ env.VERSION }})" \
            --body "$BODY")

          # Add ignore-for-release label to the backmerge PR
          gh pr edit "$PR_URL" --add-label "ignore-for-release"
